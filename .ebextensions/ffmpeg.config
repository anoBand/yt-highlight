# .ebextensions/ffmpeg.config
commands:
  01_download_epel_rpm:
    # Download the EPEL release RPM to /tmp
    command: "curl -o /tmp/epel-release.rpm https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"
    # Test: run if EPEL is not configured and ffmpeg is not installed
    test: "! yum repolist | grep -q epel && ! ffmpeg -version"

  02_install_epel_locally:
    # Install the downloaded EPEL RPM using yum localinstall
    # yum localinstall handles dependencies and GPG keys better for local RPMs.
    command: "sudo yum localinstall -y /tmp/epel-release.rpm"
    # Test: run if EPEL is still not configured (after download attempt) and ffmpeg is not installed
    test: "! yum repolist | grep -q epel && ! ffmpeg -version"

  03_clean_yum_cache_after_epel:
    # Clean yum's cache to ensure it picks up the new EPEL repository
    command: "sudo yum clean all"
    # Test: run if EPEL seems configured OR if the localinstall command likely ran, AND ffmpeg is not installed
    # This test is a bit broad but aims to run if we're in the process of setting up EPEL/ffmpeg
    test: "! ffmpeg -version"

  04_install_ffmpeg:
    # Install ffmpeg from the (hopefully) now-enabled EPEL repository
    command: "sudo yum install -y ffmpeg"
    test: "! ffmpeg -version" # Only run if ffmpeg is not installed